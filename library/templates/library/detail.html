{% extends 'library/base.html' %}
{% block content %}
<style>
    /* CSS SAMA PERSIS SEPERTI SEBELUMNYA */
    .detail-header { display: flex; gap: 30px; margin-bottom: 40px; align-items: flex-start; }
    .detail-cover { width: 200px; flex-shrink: 0; border-radius: var(--radius); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .detail-cover img { width: 100%; height: auto; display: block; aspect-ratio: 2/3; object-fit: cover; }
    .detail-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 300px; }
    .novel-title { font-size: 1.8rem; font-weight: 800; line-height: 1.3; margin-bottom: 10px; color: var(--text); }
    .meta-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; font-size: 0.85rem; }
    .tag { background: var(--card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; color: var(--gold); }
    .stats { display: flex; gap: 40px; margin-bottom: 25px; padding: 15px 0; border-top: 1px dashed var(--border); border-bottom: 1px dashed var(--border); }
    .stat-item { text-align: center; }
    .stat-item strong { display: block; font-size: 1.1rem; color: var(--text); }
    .stat-item span { font-size: 0.8rem; color: gray; text-transform: uppercase; letter-spacing: 1px; }
    .action-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
    .chapter-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 15px; }
    .chapter-item { background: var(--card); border: 1px solid var(--border); padding: 10px 15px; border-radius: 6px; font-size: 0.85rem; color: gray; transition: 0.2s; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chapter-item:hover { border-color: var(--gold); color: var(--gold); background: rgba(255,193,7,0.05); }
    .star-rating span { font-size: 1.2rem; cursor: pointer; color: #444; transition: 0.2s; }
    .star-rating span:hover, .star-rating span.active { color: #ffc107; }

    @media (max-width: 768px) {
        .detail-header { flex-direction: column; align-items: center; text-align: center; }
        .detail-cover { width: 160px; margin-bottom: 10px; }
        .meta-tags { justify-content: center; }
        .stats { justify-content: center; gap: 20px; }
        .action-buttons { justify-content: center; width: 100%; }
        .btn-auth { flex: 1; text-align: center; }
    }
</style>

<div class="detail-header">
    <div class="detail-cover">
        {% if novel.cover %}
            <img src="{{ novel.cover.url }}" alt="{{ novel.title }}">
        {% else %}
            <div style="width:100%; height:300px; background:#222; display:flex; align-items:center; justify-content:center; font-size:3rem; color:#444;">üìñ</div>
        {% endif %}
    </div>
    
    <div class="detail-info">
        <h1 class="novel-title">{{ novel.title }}</h1>
        
        <div class="meta-tags">
            <span class="tag">üë§ {{ novel.author }}</span>
            <span class="tag">üìÇ {{ novel.genre }}</span>
            <span class="tag" style="color: {% if novel.status == 'Completed' %}#2ecc71{% else %}#3498db{% endif %};">‚óè {{ novel.status }}</span>
        </div>

        <div class="stats">
            <div class="stat-item">
                <strong id="avg-score">{{ novel.average_rating }}</strong>
                <span>Rating</span>
            </div>
            <div class="stat-item">
                <strong>{{ chapters.count }}</strong>
                <span>Chapters</span>
            </div>
            <div class="stat-item">
                <div class="star-rating">
                    <span onclick="rate(1)">‚òÖ</span><span onclick="rate(2)">‚òÖ</span><span onclick="rate(3)">‚òÖ</span><span onclick="rate(4)">‚òÖ</span><span onclick="rate(5)">‚òÖ</span>
                </div>
                <span>Rate Novel</span>
            </div>
        </div>

        <div class="action-buttons">
            {% if chapters %}
                <a href="{% url 'read_chapter' chapters.first.id %}" class="btn-auth" style="padding: 10px 25px;">
                    üöÄ READ NOW
                </a>
            {% endif %}

            {% if user.is_authenticated %}
                <a href="{% url 'toggle_bookmark' novel.id %}" class="btn-auth" style="background:transparent; border:1px solid var(--border); color:var(--text);">
                    {% if is_bookmarked %}üíî Remove Library{% else %}‚ù§Ô∏è Add to Library{% endif %}
                </a>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn-auth" style="background:transparent; border:1px solid var(--border); color:var(--text);">
                    üîí Login to Bookmark
                </a>
            {% endif %}
        </div>
    </div>
</div>

<h3 style="margin-bottom: 15px; font-size: 1.1rem; border-left: 4px solid var(--gold); padding-left: 10px;">Table of Contents</h3>
<div class="chapter-list">
    {% for chap in chapters %}
        <a href="{% url 'read_chapter' chap.id %}" class="chapter-item">
            {{ chap.title }}
        </a>
    {% empty %}
        <p style="color:gray; font-style:italic;">No chapters yet.</p>
    {% endfor %}
</div>

<script>
    function rate(val) {
        fetch('/api/rate/{{ novel.id }}/', {
            method: 'POST', body: JSON.stringify({score: val})
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok') {
                document.getElementById('avg-score').innerText = data.new_avg;
                const stars = document.querySelectorAll('.star-rating span');
                stars.forEach((s, i) => {
                    if (i < val) s.classList.add('active');
                    else s.classList.remove('active');
                });
                alert('Thank you! You rated: ' + val);
            }
        });
    }
</script>
{% endblock %}